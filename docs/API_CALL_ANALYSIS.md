# API呼び出し回数の分析

## 現在の実装での1リクエストあたりのAPI呼び出し回数

### テストケース例
- `must_places`: ["太宰府天満宮", "福岡タワー"] (2箇所)
- `interest_tags`: ["カフェ", "神社"] (2タグ)
- `start_place`: デフォルト（博多駅）
- `goal_place`: 未指定

### 1. Text Search API（Places API - Text Search）
**用途**: 場所名から座標を取得

呼び出し回数:
- 出発地点: 0回（博多駅はデフォルト値を使用）
- ゴール地点: 0回（未指定）
- 寄りたい場所: 2回（太宰府天満宮、福岡タワー）

**合計: 2回**

### 2. Nearby Search API（Places API - Nearby Search）
**用途**: 各エッジの中点周辺で場所を検索

計算:
- 座標数: 3点（出発地点、2箇所の寄りたい場所）
- MSTのエッジ数: 2本（3点 → n-1 = 2エッジ）
- 興味タグ数: 2（カフェ、神社）

呼び出し回数:
- エッジ1 × 興味タグ2 = 2回
- エッジ2 × 興味タグ2 = 2回

**合計: 4回**

### 3. Place Details API（Places API - Place Details）
**用途**: 候補場所の詳細情報を取得

呼び出し回数:
- 最大10回（最終的に選ばれた候補数）

**合計: 最大10回**

### 4. Place Photo API（Places API - Place Photo）
**用途**: 写真URLを生成

呼び出し回数:
- Place Details APIのレスポンスから`photo_reference`を使用してURLを生成
- 実際のHTTPリクエストは発生しない（URL文字列を生成するのみ）

**合計: 0回（HTTPリクエストは発生しない）**

---

## 総API呼び出し回数（1リクエストあたり）

| API | 呼び出し回数 |
|-----|------------|
| Text Search | 2回 |
| Nearby Search | 4回 |
| Place Details | 最大10回 |
| Place Photo | 0回（URL生成のみ） |
| **合計** | **最大16回** |

---

## Google Maps Platform 料金体系（2025年3月以降）

### カテゴリ別の無料枠
- **Essentialsカテゴリ**: 月10,000回まで無料
- **Proカテゴリ**: 月5,000回まで無料
- **Enterpriseカテゴリ**: 月1,000回まで無料

### Places API の分類
Places APIは**Proカテゴリ**に属するため：
- **月5,000回まで無料**

---

## 課金が開始される回数の計算

### 前提条件
- 1リクエストあたりのAPI呼び出し: **最大16回**
- Places APIの無料枠: **月5,000回**

### 計算式
```
無料枠を超えるリクエスト数 = (月5,000回) / (1リクエストあたり16回) = 312.5回
```

### 結果
- **312回まで無料**でテスト可能
- **313回目から課金**が開始される

### より正確な計算（変動を考慮）

#### 最良ケース（API呼び出しが少ない場合）
- 寄りたい場所: 1箇所 → Text Search: 1回
- エッジ数: 2 → Nearby Search: 4回
- 候補数: 5件 → Place Details: 5回
- **合計: 10回**
- **無料でテスト可能: 500回**

#### 最悪ケース（API呼び出しが多い場合）
- 寄りたい場所: 5箇所 → Text Search: 5回
- エッジ数: 6 → Nearby Search: 12回（エッジ6 × タグ2）
- 候補数: 10件 → Place Details: 10回
- **合計: 27回**
- **無料でテスト可能: 185回**

---

## 推奨事項

1. **テスト回数の監視**
   - Google Cloud ConsoleでAPI使用量を定期的に確認
   - 無料枠の残り回数を把握

2. **コスト最適化**
   - 不要なAPI呼び出しを削減
   - キャッシュの導入を検討
   - テスト時は候補数を減らす（例: 最大5件）

3. **エラー処理の改善**
   - API呼び出しが失敗した場合のリトライロジック
   - レート制限エラーの処理

---

## 注意事項

- 上記の料金体系は2025年3月以降の情報です
- 実際の料金体系はGoogle Maps Platformの公式ドキュメントで確認してください
- 無料枠は月単位でリセットされます
- APIの種類によってカテゴリが異なる場合があります

